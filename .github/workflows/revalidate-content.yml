# GitHub Actions ì›Œí¬í”Œë¡œìš° - ì½˜í…ì¸  ë³€ê²½ ê°ì§€ ë° ì„œë²„ ë°°í¬ ì•Œë¦¼
name: Content Revalidation and Deployment

on:
  push:
    branches: [main]
    paths:
      - 'content/posts/**/*.md'
      - 'content/pages/**/*.md'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            content/posts/**/*.md
            content/pages/**/*.md

      - name: Install jq
        if: steps.changed-files.outputs.any_changed == 'true'
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: List changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ðŸ“ Content files changed:"
          echo "All changed: ${{ steps.changed-files.outputs.all_changed_files }}"
          echo "Added: ${{ steps.changed-files.outputs.added_files }}"
          echo "Modified: ${{ steps.changed-files.outputs.modified_files }}"
          echo "Deleted: ${{ steps.changed-files.outputs.deleted_files }}"

      - name: Send webhook
        run: |
          echo "ðŸ”” Sending webhook to server..."
          echo "ðŸ“ Environment variables verified"
          echo "ðŸŽ¯ Target URL: ${{ secrets.SERVER_WEBHOOK_URL }}"
          
          # íŽ˜ì´ë¡œë“œ ìƒì„± (ì‚­ì œëœ íŒŒì¼ ì •ë³´ í¬í•¨)
          PAYLOAD=$(jq -nc \
            --arg ref "refs/heads/main" \
            --arg repo_name "${{ github.repository }}" \
            --arg commit_id "${{ github.sha }}" \
            --arg message "Content update via GitHub Actions" \
            --argjson changed_files "$(echo '${{ steps.changed-files.outputs.all_changed_files }}' | jq -R 'split(" ")')" \
            --argjson added_files "$(echo '${{ steps.changed-files.outputs.added_files }}' | jq -R 'split(" ")')" \
            --argjson modified_files "$(echo '${{ steps.changed-files.outputs.modified_files }}' | jq -R 'split(" ")')" \
            --argjson deleted_files "$(echo '${{ steps.changed-files.outputs.deleted_files }}' | jq -R 'split(" ")')" \
            '{
              ref: $ref,
              repository: {
                name: $repo_name,
                full_name: $repo_name
              },
              commits: [{
                id: $commit_id,
                message: $message,
                added: $added_files,
                modified: $modified_files,
                removed: $deleted_files
              }],
              action: "content_update",
              changed_files: $changed_files,
              added_files: $added_files,
              modified_files: $modified_files,
              deleted_files: $deleted_files
            }'
          )
          
          echo "ðŸ“¦ Payload prepared:"
          echo "$PAYLOAD"
          
          # HMAC ì„œëª… ìƒì„±
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "${{ secrets.WEBHOOK_SECRET }}" | sed 's/^.* //')
          echo "ðŸ” Signature generated: sha256=$SIGNATURE"
          
          # ì›¹í›… ì „ì†¡ (ê°œì„ ëœ ì—ëŸ¬ ì²˜ë¦¬)
          echo "ðŸ“¡ Sending webhook..."
          
          # ìž„ì‹œ íŒŒì¼ì„ ì‚¬ìš©í•œ ì•ˆì „í•œ ì‘ë‹µ ì²˜ë¦¬
          TEMP_RESPONSE=$(mktemp)
          HTTP_STATUS=$(curl -s -o "$TEMP_RESPONSE" -w "%{http_code}" \
            --connect-timeout 10 \
            --max-time 30 \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -d "$PAYLOAD" \
            "${{ secrets.SERVER_WEBHOOK_URL }}")
          
          RESPONSE_BODY=$(cat "$TEMP_RESPONSE")
          rm -f "$TEMP_RESPONSE"
          
          echo "ðŸ“Š HTTP Status: $HTTP_STATUS"
          echo "ðŸ“„ Response:"
          echo "$RESPONSE_BODY"
          
          # ì„±ê³µ ì—¬ë¶€ í™•ì¸ (HTTP 200ê³¼ ì‘ë‹µ ë‚´ìš© ê²€ì¦)
          if [ "$HTTP_STATUS" = "200" ]; then
            # JSON ì‘ë‹µì—ì„œ success í•„ë“œ í™•ì¸
            if echo "$RESPONSE_BODY" | jq -e '.success' > /dev/null 2>&1; then
              echo "âœ… Webhook sent successfully - Deployment completed"
            elif echo "$RESPONSE_BODY" | jq -e '.status' > /dev/null 2>&1; then
              echo "âœ… Webhook sent successfully - Server responded"
            else
              echo "âš ï¸ Webhook sent but response format unexpected"
              echo "$RESPONSE_BODY"
            fi
          else
            echo "âŒ Webhook failed (HTTP $HTTP_STATUS)"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi

      - name: Deployment summary
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Changed files**: ${{ steps.changed-files.outputs.all_changed_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Expected deploy time**: ~2-3 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- **Site URL**: https://greedient.kr" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Webhook sent to server" >> $GITHUB_STEP_SUMMARY
