# GitHub Actions ì›Œí¬í”Œë¡œìš° - ì½˜í…ì¸  ë³€ê²½ ê°ì§€ ë° ì„œë²„ ë°°í¬ ì•Œë¦¼
name: Content Revalidation and Deployment

on:
  push:
    branches: [main]
    paths:
      - 'content/posts/**/*.md'
      - 'content/pages/**/*.md'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            content/posts/**/*.md
            content/pages/**/*.md

      - name: Install jq
        if: steps.changed-files.outputs.any_changed == 'true'
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: List changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ğŸ“ Content files changed:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

      - name: Send webhook to server
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
          SERVER_WEBHOOK_URL: ${{ secrets.SERVER_WEBHOOK_URL }}
        run: |
          echo "ğŸ”” Sending webhook to server..."
          
          # í™˜ê²½ë³€ìˆ˜ í™•ì¸
          if [ -z "$WEBHOOK_SECRET" ]; then
            echo "âŒ WEBHOOK_SECRET is not set"
            exit 1
          fi
          
          if [ -z "$SERVER_WEBHOOK_URL" ]; then
            echo "âŒ SERVER_WEBHOOK_URL is not set"
            exit 1
          fi
          
          echo "ğŸ“ Environment variables verified"
          echo "ğŸ¯ Target URL: $SERVER_WEBHOOK_URL"
          
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ì„ JSON ë°°ì—´ë¡œ ë³€í™˜
          CHANGED_FILES_JSON=$(echo '${{ steps.changed-files.outputs.all_changed_files }}' | jq -R 'split(" ")')
          
          # ì›¹í›… í˜ì´ë¡œë“œ ìƒì„± (ë” ê°„ë‹¨í•œ í˜•íƒœ)
          PAYLOAD=$(cat <<EOF
          {
            "ref": "refs/heads/main",
            "repository": {
              "name": "${{ github.repository }}",
              "full_name": "${{ github.repository }}"
            },
            "commits": [
              {
                "id": "${{ github.sha }}",
                "message": "Content update via GitHub Actions",
                "modified": $CHANGED_FILES_JSON
              }
            ],
            "action": "content_update",
            "changed_files": $CHANGED_FILES_JSON
          }
          EOF
          )
          
          echo "ğŸ“¦ Payload prepared:"
          echo "$PAYLOAD" | jq .
          
          # HMAC ì„œëª… ìƒì„±
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | cut -d' ' -f2)
          echo "ğŸ” Signature generated: sha256=$SIGNATURE"
          
          # ì›¹í›… ì „ì†¡
          echo "ğŸ“¡ Sending webhook..."
          HTTP_STATUS=$(curl -s -o /tmp/webhook_response.txt -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -H "X-GitHub-Event: push" \
            -H "User-Agent: GitHub-Hookshot/manual" \
            -d "$PAYLOAD" \
            "$SERVER_WEBHOOK_URL")
          
          echo "ğŸ“Š HTTP Status: $HTTP_STATUS"
          echo "ğŸ“„ Response:"
          cat /tmp/webhook_response.txt || echo "No response body"
          
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… Webhook sent successfully (HTTP $HTTP_STATUS)"
          else
            echo "âŒ Webhook failed (HTTP $HTTP_STATUS)"
            exit 1
          fi

      - name: Deployment summary
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Changed files**: ${{ steps.changed-files.outputs.all_changed_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Expected deploy time**: ~2-3 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- **Site URL**: https://greedient.kr" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Webhook sent to server" >> $GITHUB_STEP_SUMMARY
